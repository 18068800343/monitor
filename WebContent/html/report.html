<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>高速桥梁监测系统集成管理平台</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
		<link rel="shortcut icon" href="../font/favicon.ico" type="image/x-icon" />
		<link rel="stylesheet" type="text/css" media="screen" href="../style/bootstrap.min.css">
		<link rel="stylesheet" href="../font/iconfont.css">
		<link rel="stylesheet" href="../font2/iconfont.css">
		<link href="../style/style.css" rel="stylesheet">
        <link href="../style/style2.css" rel="stylesheet">
   		<link href="../js/toastr/toastr.min.css" rel="stylesheet">
        <link rel="stylesheet" href="../style/jquery.dataTables.min.css">
		<link rel="stylesheet" href="../js/plugin/daterangepicker/daterangepicker.css">
		 <!-- SmartAdmin Styles : Caution! DO NOT change the order -->
	    <link rel="stylesheet" type="text/css" media="screen" href="../css/smartadmin-production-plugins.min.css">
	    <link rel="stylesheet" type="text/css" media="screen" href="../css/smartadmin-production.min.css">
	    <link rel="stylesheet" type="text/css" media="screen" href="../css/smartadmin-skins.min.css">
	    <link rel="stylesheet" type="text/css" media="screen" href="../css/font.css">
	    <!-- SmartAdmin RTL Support  -->
	    <link rel="stylesheet" type="text/css" media="screen" href="../css/smartadmin-rtl.min.css">
		<style>
			body{
				background: #fff;
			}
			.yihang{
				display:flex;
				align-items: center;
			}
			.caise{
				background:rgb(186, 221, 235);
			}
			a{
		  		cursor:pointer;
			}
			.zhongjian{
				text-align:center;
			}
		</style>
<body>

		<section>
			<!-- header -->
			<header class="header">
            <div>
                <p style="font-size:28px;margin: 0px;"><img src="../img/qiaoLogo.png" alt="" style="width:48px;height:50%;">&nbsp;高速桥梁监测系统集成管理平台</p>
            </div>
            <div style="display:flex;">
	                <div class="renyuan zhuashou"><a href="#"><img src="../img/登陆人.png" alt="">&nbsp;<span id="uname"></span></a></div>
	                <div style="padding-top:5px;">丨</div>
	                <div class="renyuan zhuashou"><a href="#" id="logOut"><img src="../img/退出.png" alt="">&nbsp;退出</a></div>
	        </div>
        </header>
        <div>
        	<div class="caidanlan">
        			<div class="box1 yihang3" id="boxa">
		                <p style="padding-top:10px;"><a href="./index.html" ><!-- <span class="glyphicon glyphicon-home" aria-hidden="true" style="color:#fff;font-size:16px;"></span> -->首页</a></p>
		            </div>
		            
		            <div class="btn-group" role="group">
					    <div class="dropdown-toggle box1" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" id="boxb">
					     <p><!-- <i class="iconfont icon-qiaoliang" style="color:#fff;font-size:20px;"></i> -->桥梁信息</p>
					      
					    </div>
					    <ul class="dropdown-menu" id="qiaoSlect">
					      
					    </ul>
				  </div>
				  
				  <div class="btn-group" role="group">
					    <div class="dropdown-toggle box1" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" id="boxc">
		                <p><!-- <i class="iconfont icon-jiancedianguanli"></i> -->测点管理</p>
					    </div>
					    <ul class="dropdown-menu" id="qiaoSlect2">
					      
					    </ul>
				  </div>
				  
				  <div class="btn-group" role="group">
					    <div class="dropdown-toggle box1" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" id="boxd">
		                <p><!-- <i class="iconfont icon-shujuguanli"></i> -->数据管理</p>
					    </div>
					    <ul class="dropdown-menu" id="qiaoSlect3">
					      
					    </ul>
				  </div>
				  
				  <div class="btn-group" role="group">
					    <div class="dropdown-toggle box1" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" id="boxe">
		                <p><!-- <i class="iconfont icon-yujing" style="font-size:20px;"></i> -->分析预警</p>
					    </div>
					    <ul class="dropdown-menu" id="qiaoSlect4">
					      
					    </ul>
				  </div>
				  <div class="box1active" id="boxf" >
		                <p><a href="./report.html"><!-- <i class="iconfont icon-book-thick" style="color:white;font-size:20px;"></i> -->监测报告</a></p>
		            </div>
		            <div class="box1" id="boxg" >
		                <p><a href="./cidian.html"><!-- <i class="iconfont icon-book-thick" style="color:white;font-size:20px;"></i> -->基础数据</a></p>
		            </div>
        	</div>
        </div>
			
			
		</section>

		
			<div style="text-align:right;margin-top: 10px;margin-bottom: 10px;">
				<a class="btn btn-primary" onclick="openReport()">批量报告</a>
			</div>
		<div id="content">
				
			<div class="row">
				<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12 ">
					
					<div style="background:#fff;">
						<div role="content">
							
							<div style="margin-top: 5px;">
								<table  class="table table-striped table-bordered table-hover" id="maincontent" >
									<thead>
										<tr role="row">
											<th>任务编号</th>
											<th>结构名称</th>
											<th>结构编号</th>
											<th style="width:30%;">报告名称</th>
											<th style="width:8%;">报告状态</th>
											<th>生成时间</th>
											<th>操作</th>
										</tr>
									</thead>

									<tbody>
									</tbody>
								</table>
							</div>

						</div>
					</div>
				</div>
			
			</div>
			<div class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" id="myModal">
			    <div class="modal-dialog modal-lg" role="document">
			        <div class="modal-content">
			        <div class="modal-header">
			            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
			            <h4 class="modal-title" id="myModalLabel"><b>生成报告</b></h4>
			        </div>
			        <div class="modal-body">
			           <table  class="table table-striped table-bordered table-hover" id="maincontent2" >
							<thead>
								<tr>
									<th>
										<input type="checkbox" id="topBox" style="width:22px;height:22px;">
									</th>
									<th>结构名称</th>
									<th>结构编号</th>
								</tr>
							</thead>
							<tbody></tbody>
						</table>
			        </div>
			        <div class="modal-footer">
			            <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
			            <button type="button" class="btn btn-success"  onclick="addReport()">生成</button>
			        </div>
			        </div>
			    </div>
			</div>
					
		</div>
	
	

<script src="../js/jquery.js"></script>
<script src="../js/bootstrap.min.js"></script>
<script src="../js/common-scripts.js"></script>
<script src="../js/caidan.js"></script>
<script src="../js/echarts.min.js"></script>
<script src="../js/toastr/toastr.min.js"></script>
<script src="../js/jquery.dataTables.min.js"></script>
<script src="../js/plugin/daterangepicker/moment.min.js"></script>
<script src="../js/plugin/daterangepicker/daterangepicker.js"></script>
<script src="../js/laydate/laydate.js"></script>
<script src="../js/myTool.js"></script>
<script src="../js/login.js"></script>
<script src="../js/SmartNotification.min.js"></script>
<!-- <script src="js/main.js"></script> -->
<script>
	$(document).ready( function () {
		showUserName();
		initMenu();
		initTable();
	});
	
	var table=$('#maincontent').dataTable({
	    "deferRender": true,
	    "processing": true,
	    "bDestroy": true,
	    "iDisplayLength": 10,
	    "searching": true,
	    "lengthChange": false,
	    "oLanguage": {
		    "sSearch": '<span class="input-group-addon"><i class="glyphicon glyphicon-search"></i></span>'
		},
		"columns": [
					{"data": "rNo"},
					{"data": "brgName"},
					{"data": "brgNo"},
					{"data": "reportName"},
					{"data": null},
					{"data": "reportTime"},
					{"data": null},
		        ],
		        "columnDefs": [
								{	
										 "class": "tcenter",
										    "targets": 6,
										    "searchable": true,
										    "render": function(data, type, full) {
											    	if(full.reportStatus=="1"){
											    		return "<button class='down btn btn-warning btn-xs' onclick='down(this)'><span class='glyphicon glyphicon-save'></span></button><button class='del btn btn-warning btn-xs' onclick='del(this)'><span class='glyphicon glyphicon-trash'></span></button>";  
										    		}else{
										    			return "<button class='del btn btn-warning btn-xs' onclick='del(this)'><span class='glyphicon glyphicon-trash'></span></button>";  
										    		}
										    	}
										  },{	
												 "class": "tcenter",
												    "targets": 4,
												    "searchable": true,
												    "render": function(data, type, full) {
												    		if(full.reportStatus=="1"){
												    			return "<span class='label label-success state'>成功</span>";  
												    		}else{
												    			return "<span class='label label-danger state'>失败</span>";  
												    		}
												    	}
												  }
								],
	    "order": [[0, 'asc']],
	    "oLanguage": { //国际化配置
	    "sProcessing": "正在获取数据，请稍后...",
	    "sLengthMenu": "显示 _MENU_ 条",
	    "sZeroRecords": "查询不到相关数据",
	    "sInfo": "从 _START_ 到  _END_ 条记录 总记录数为 _TOTAL_ 条",
	    "sInfoEmpty": "记录数为0",
	    "sInfoFiltered": "(全部记录数 _MAX_ 条)",
	    "sInfoPostFix": "",
	    "sSearch": "搜索",
	    "sUrl": "",
	    "oPaginate": {
	        "sFirst": "第一页",
	        "sPrevious": "上一页",
	        "sNext": "下一页",
	        "sLast": "最后一页"
	    }},
	
	});
	
	var table2=$('#maincontent2').dataTable({
	    "deferRender": true,
	    "processing": true,
	    "bDestroy": true,
	    "iDisplayLength": 10,
	    "searching": true,
	    "lengthChange": false,
	    "oLanguage": {
		    "sSearch": '<span class="input-group-addon"><i class="glyphicon glyphicon-search"></i></span>'
		},
		"columns": [
					{"data": null,'orderable': false },
					{"data": "bridge_name"},
					{"data": "bridge_no"}
		        ],
		        "columnDefs": [
								{	
										 "class": "zhongjian",
										    "targets": 0,
										    "searchable": true,
										    "render": function(data, type, full) {
										    		return '<input type="checkbox" name="checkbox" onclick="boxClick(this)" class="otherBox" style="width:22px;height:22px;">';
										    	}
										  }
								],
	    "order": [[1, 'asc']],
	    "oLanguage": { //国际化配置
	    "sProcessing": "正在获取数据，请稍后...",
	    "sLengthMenu": "显示 _MENU_ 条",
	    "sZeroRecords": "查询不到相关数据",
	    "sInfo": "从 _START_ 到  _END_ 条记录 总记录数为 _TOTAL_ 条",
	    "sInfoEmpty": "记录数为0",
	    "sInfoFiltered": "(全部记录数 _MAX_ 条)",
	    "sInfoPostFix": "",
	    "sSearch": "搜索",
	    "sUrl": "",
	    "oPaginate": {
	        "sFirst": "第一页",
	        "sPrevious": "上一页",
	        "sNext": "下一页",
	        "sLast": "最后一页"
	    }},
	
	});
	
	function initTable(){
        $.ajax({
            type: 'get',
            url: '../MonitorReportServlet',
            dataType: 'json',
            data: {
            	type:"selectMonitorReport"
            },
            success: function (json) {
            	var data=json.obj;
                $('#maincontent').dataTable().fnClearTable();
                $('#maincontent').DataTable().rows.add(data).draw(false);
            }
        });
    }
	
	function initTable2(){
        $.ajax({
            type: 'get',
            url: '../BrgCardServlet',
            dataType: 'json',
            data: {
            	type:"selectAllBrg"
            },
            success: function (json) {
            	var data=json.obj;
                $('#maincontent2').dataTable().fnClearTable();
                $('#maincontent2').DataTable().rows.add(data).draw(false);
            }
        });
    }
	
	function del(obj){
		var tr=$(obj).parents("tr");
		var data=$("#maincontent").DataTable().row(tr).data();
		var id=data.rId;
		$.SmartMessageBox({
            title: "删除提示",
            content: "确认删除？",
            buttons: '[取消][确定]'
        }, function (ButtonPressed) {
        	if (ButtonPressed === "确定") {
        		$.ajax({
                    type: 'get',
                    url: '../MonitorReportServlet',
                    dataType: 'json',
                    data: {
                    	type:"deleteMonitorReport",
                    	id:id
                    },
                    success: function (json) {
                    	var data=json.obj;
                    	if(data>0){
                    		$("#maincontent").DataTable().row(tr).remove().draw(false);
                    		toastr.success("删除成功");
                    	}else{
                    		toastr.error("删除失败");
                    	}
                    }
                });
        	}
       });
        
	}
	
	function initMenu(){
		$.ajax({
            type: 'GET',
            url: '../BrgCardServlet',
            dataType: 'json',
            data: {
                type: "selectAllBrg"
            },
            error: function (msg) {
                toastr.error("系统错误！");
            },
            success: function (json) {
                if (json.success == "success") {
                	var arr = json.obj;
                	$("#qlgl").html('');
                	$("#cdgl").html('');
                	$("#sjgl").html('');
                	$("#fxyj").html('');
                    for (var i = 0; i < arr.length; i++) {
                    	$("#qiaoSlect").append('<li><a href="./qiaoliangguanli.html?'+arr[i].bridge_id+'">'+arr[i].bridge_name+'</a></li>')
                    	$("#qiaoSlect2").append('<li><a href="./cedianguanli.html?'+arr[i].bridge_id+'">'+arr[i].bridge_name+'</a></li>')
                    	$("#qiaoSlect3").append('<li><a href="./shujuguanli.html?'+arr[i].bridge_id+'">'+arr[i].bridge_name+'</a></li>')
                    	$("#qiaoSlect4").append('<li><a href="./yujin.html?'+arr[i].bridge_id+'">'+arr[i].bridge_name+'</a></li>')
                    }
                }else {
                    toastr.error("初始桥梁出错");
                }
            }
        });
	}
	
	var brgIdArray=new Array();
	
	function  openReport(){
		initTable2();
		brgIdArray=[];
		$("#myModal").modal("show");
	}
	
	
	$("#topBox").on("click",function(){
		if($("#topBox").is(':checked')){
			$("input[name='checkbox']").each(function(){ 
				if($(this).is(':checked')){
					var tr=$(this).parents("tr");
					var data=$("#maincontent2").DataTable().row(tr).data();
					var brgId=data.bridge_id;
					brgIdArray.splice($.inArray(brgId,brgIdArray),1);
				}
			})
			$(".otherBox").prop("checked",true);
			$("input[name='checkbox']").each(function(){ 
				if($(this).is(':checked')){
					var tr=$(this).parents("tr");
					var data=$("#maincontent2").DataTable().row(tr).data();
					var brgId=data.bridge_id;
					brgIdArray.push(brgId);
				}
			})
		}else{
			$("input[name='checkbox']").each(function(){ 
				if($(this).is(':checked')){
					var tr=$(this).parents("tr");
					var data=$("#maincontent2").DataTable().row(tr).data();
					var brgId=data.bridge_id;
					brgIdArray.splice($.inArray(brgId,brgIdArray),1);
				}
			})
			$(".otherBox").removeAttr("checked");
		}
	})
	
	function boxClick(obj){
		var tr=$(obj).parents("tr");
		var data=$("#maincontent2").DataTable().row(tr).data();
		var brgId=data.bridge_id;
		if($(obj).is(':checked')){
			brgIdArray.push(brgId);
		}else{
			brgIdArray.splice($.inArray(brgId,brgIdArray),1);
		}
		
	}
	
	function addReport(){
		myTool.mask.show('生成中...');
		$.ajax({
            type: 'get',
            url: '../MonitorReportServlet',
            dataType: 'json',
            data: {
            	type:"addMonitorReport",
            	brgIdArray:brgIdArray.toString()
            },
            success: function (json) {
            	var data=json.obj;
            	if(data>0){
            		location.reload([true]);
            		toastr.success("生成成功");
            	}else{
            		toastr.error("生成失败");
            	}
            	myTool.mask.hide();
            }
        });
	}
	 
	function down(obj){
		var tr=$(obj).parents("tr");
		var data=$("#maincontent").DataTable().row(tr).data();
		var path=data.reportUrl;
		var name=data.reportName;
		window.location.href=encodeURI("../MonitorReportServlet?type=downloadFile&fileName="+name+"&filePath="+path);
	}
	
    function showMask() {
    	myTool.mask.show('查询中...');
    }
    function hidMask() {
    	myTool.mask.hide();
    }
    
	  /*去除DateTables 表格无参数错误提示*/
	$.fn.dataTable.ext.errMode = function(s,h,m){}
</script>
		
	
</body>
</html>